version: '3.8'

services:
  # Servidor Nginx
  nginx:
    build:
      context: .
      dockerfile: .deploy/nginx.Dockerfile
    ports:
      - "9092:80"
      - "${NGINX_SSL_PORT}:443"
    volumes:
      - .:/var/www/html
    depends_on:
      - app
    networks:
      - registros_network
    container_name: ${NGINX_CONTAINER_NAME}

  # Aplicaci√≥n Laravel con Octane
  app:
    build:
      context: .
      dockerfile: .deploy/app.Dockerfile
      args:
        PHP_VERSION: ${PHP_VERSION}
        PHP_MEMORY_LIMIT: ${PHP_MEMORY_LIMIT}
        PHP_MAX_EXECUTION_TIME: ${PHP_MAX_EXECUTION_TIME}
        PHP_UPLOAD_MAX_FILESIZE: ${PHP_UPLOAD_MAX_FILESIZE}
        PHP_POST_MAX_SIZE: ${PHP_POST_MAX_SIZE}
        OPCACHE_VALIDATE_TIMESTAMPS: ${OPCACHE_VALIDATE_TIMESTAMPS}
        OPCACHE_MEMORY_CONSUMPTION: ${OPCACHE_MEMORY_CONSUMPTION}
        APP_KEY: ${APP_KEY}
        APP_NAME: ${APP_NAME}
        APP_URL: ${APP_URL}
        APP_ENV: ${APP_ENV}
        APP_DEBUG: ${APP_DEBUG}
        APP_TIMEZONE: ${APP_TIMEZONE}
        APP_LOCALE: ${APP_LOCALE}
        APP_FALLBACK_LOCALE: ${APP_FALLBACK_LOCALE}
        LOG_CHANNEL: ${LOG_CHANNEL}
        LOG_LEVEL: ${LOG_LEVEL}
        DB_CONNECTION: ${DB_CONNECTION}
        DB_HOST: db
        DB_PORT: ${DB_PORT}
        DB_DATABASE: ${DB_DATABASE}
        DB_USERNAME: ${DB_USERNAME}
        DB_PASSWORD: ${DB_PASSWORD}
        BROADCAST_DRIVER: ${BROADCAST_DRIVER}
        CACHE_DRIVER: ${CACHE_DRIVER}
        QUEUE_CONNECTION: ${QUEUE_CONNECTION}
        SESSION_DRIVER: ${SESSION_DRIVER}
        SESSION_LIFETIME: ${SESSION_LIFETIME}
        SESSION_SECURE_COOKIE: ${SESSION_SECURE_COOKIE}
        SESSION_COOKIE_HTTPONLY: ${SESSION_COOKIE_HTTPONLY}
        REDIS_HOST: redis
        REDIS_PASSWORD: ${REDIS_PASSWORD}
        REDIS_PORT: ${REDIS_PORT}
        MAIL_MAILER: ${MAIL_MAILER}
        MAIL_HOST: ${MAIL_HOST}
        MAIL_PORT: ${MAIL_PORT}
        MAIL_USERNAME: ${MAIL_USERNAME}
        MAIL_PASSWORD: ${MAIL_PASSWORD}
        MAIL_ENCRYPTION: ${MAIL_ENCRYPTION}
        MAIL_FROM_ADDRESS: ${MAIL_FROM_ADDRESS}
        MAIL_FROM_NAME: ${MAIL_FROM_NAME}
        SANCTUM_STATEFUL_DOMAINS: ${SANCTUM_STATEFUL_DOMAINS}
        SESSION_DOMAIN: ${SESSION_DOMAIN}
        OCTANE_SERVER: ${OCTANE_SERVER}
        RUN_MIGRATIONS: ${RUN_MIGRATIONS}
        RUN_SEEDERS: ${RUN_SEEDERS}
    volumes:
      - .:/var/www/html
    depends_on:
      - db
      - redis
    networks:
      - registros_network
    container_name: ${APP_CONTAINER_NAME}
    ports:
      - "${APP_PORT}:8000"  # Puerto para Octane

  # Base de datos MySQL
  db:
    image: mysql:8.0
    ports:
      - "${DB_EXTERNAL_PORT}:3306"
    environment:
      - MYSQL_DATABASE=${DB_DATABASE}
      - MYSQL_USER=${DB_USERNAME}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_ROOT_HOST=${MYSQL_ROOT_HOST}
    volumes:
      - registros_db_data:/var/lib/mysql
    networks:
      - registros_network
    container_name: ${DB_CONTAINER_NAME}
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${DB_HEALTHCHECK_USER}", "-p${DB_HEALTHCHECK_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      
  # Redis ss
  redis:
    image: redis:alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "${REDIS_PORT}:6379"
    volumes:
      - registros_redis_data:/data
    networks:
      - registros_network
    container_name: ${REDIS_CONTAINER_NAME}

networks:
  registros_network:
    driver: bridge

volumes:
  registros_db_data:
    driver: local
  registros_redis_data:
    driver: local